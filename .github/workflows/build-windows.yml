name: Build Windows App

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true
    
    - name: Fix Windows Files with Correct Encoding
      shell: pwsh
      run: |
        Write-Host "=== Fixing Windows files with correct encoding ===" -ForegroundColor Cyan
        
        # 1. Fix resource.h with Windows line endings (CRLF)
        $resourceContent = "#pragma once`r`n`r`n#define IDI_APP_ICON 101`r`n#define IDR_APPLICATION_MANIFEST 102"
        Set-Content -Path "windows/runner/resource.h" -Value $resourceContent -Encoding ASCII
        Write-Host "✅ Fixed resource.h with Windows line endings" -ForegroundColor Green
        
        # 2. Fix runner.rc with Windows line endings (CRLF) - CRITICAL!
        $runnerRcContent = "#include `"resource.h`"`r`n`r`nIDI_APP_ICON ICON `"resources/app_icon.ico`"`r`n`r`nIDR_APPLICATION_MANIFEST RT_MANIFEST `"runner.exe.manifest`""
        Set-Content -Path "windows/runner/runner.rc" -Value $runnerRcContent -Encoding ASCII
        Write-Host "✅ Fixed runner.rc with Windows line endings" -ForegroundColor Green
        
        # 3. Check what's actually in the file
        Write-Host "=== Verifying file contents ===" -ForegroundColor Yellow
        Write-Host "runner.rc content (hex):" -ForegroundColor Cyan
        Format-Hex -Path "windows/runner/runner.rc" | Select-Object -First 5
        
        Write-Host "runner.rc content (text):" -ForegroundColor Cyan
        Get-Content -Path "windows/runner/runner.rc" -Raw
        
        # 4. Ensure resources directory exists
        $resourcesPath = "windows/runner/resources"
        if (!(Test-Path $resourcesPath)) {
            New-Item -ItemType Directory -Path $resourcesPath -Force | Out-Null
            Write-Host "✅ Created resources directory" -ForegroundColor Green
        }
        
        # 5. Check if icon exists, create if not
        $iconPath = "$resourcesPath/app_icon.ico"
        if (!(Test-Path $iconPath)) {
            # Create minimal valid icon
            $iconBytes = [byte[]]@(
                0x00,0x00,0x01,0x00,0x01,0x00,0x01,0x01,0x00,0x00,0x01,0x00,0x08,0x00,0x28,0x00,
                0x00,0x00,0x16,0x00,0x00,0x00,0x28,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x02,0x00,
                0x00,0x00,0x01,0x00,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,
                0xFF,0x00,0x00,0x00,0x00,0x00
            )
            [System.IO.File]::WriteAllBytes($iconPath, $iconBytes)
            Write-Host "✅ Created app_icon.ico" -ForegroundColor Green
        }
    
    - name: Install Dependencies
      run: flutter pub get
    
    - name: Build Windows
      run: flutter build windows --debug
